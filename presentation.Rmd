---
title: "Introdução ao GAMLSS"
author: "Victor Dalla, Jordão Bragantini"
output: 
  beamer_presentation:
    fig_crop: false
header-includes:
  - \usepackage[brazil, english, portuguese]{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[fixlanguage]{babelbib}

  - \usepackage{graphicx}
  - \usepackage{wrapfig}
  - \usepackage{pdfpages}
  
  - \usepackage{amsfonts}
  - \usepackage{amssymb}
  - \usepackage{amsmath}
  
  - \usepackage{subcaption}
  - \usepackage{booktabs}
  - \usepackage{caption}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  results = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  digits = 3, 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r libs}
library(gamlss)
library(magrittr)
library(ggplot2)
library(broom)
library(knitr)
library(dplyr)
```

```{r loading data}
df <- gamlss.data::rent99 %>% as_tibble() %>% 
  dplyr::select(rent, area, yearc, location, cheating)
```



# Motivação: Aluguel de imóveis em Munique

- Pesquisa realizada em 1999 em Munique (Alemanha) onde foram amostrados 1969 novos contratos de aluguéis dos quatro anos anteriores
- A variável resposta *rent* ($\mathbf{Y}$) é o valor mensal do aluguel (em Marcos Alemães)
- As variáveis explicativas são:
    - *area* ($\mathbf{x}_{1}$): Área em metros quadrados dos imóveis
    - *yearc* ($\mathbf{x}_{2}$): Ano de construção.
    - *cheating* ($\mathbf{x}_{3}$): Contém aquecedor? Sim (0) e não (1)
    - *location* ($\mathbf{x}_{4}$): Localização: abaixo da média (1), média (2) ou acima da média (3)

----

## Ánalise descritiva

```{r descriptive_analysis}
par(mfrow=c(2,2))
plot(rent ~ ., data = df, col=gray(0.5, 0.5), pch=21, cex=0.8)
```

---

## Modelo Linear Simples (Modelo Normal)

$$
Y_{i} = \beta_{0} + \beta_{1} x_{i 1} + \beta_{2} x_{i 2} + \beta_{3} 1(x_{i 3} = 1) + \beta_{4} 1(x_{i 4} = 2) + \beta_{5} 1(x_{i 4} = 3) + \epsilon_{i}, \ \epsilon_{i} \stackrel{\text{ind}}{\sim} \mathcal{N}\left(0, \sigma^{2}\right)
$$

- Problemas:
    - Heterocedasticidade
    - Relação complexa (talvez não linear) entre as variáveis e suas interações
    - Assimetria positiva da variável resposta

---

## Modelo Linear Simples: Resultados

```{r normal_model}
normal_model <- gamlss(rent ~ area + yearc + location + cheating, family=NO, trace=F, data=df)
```

\begin{table}[]
\centering
\caption{}
\label{tab:normal_model}
\begin{tabular}{llllll}
\hline
Parâmero & Termo       & Estimativa & EP      & IC(95\%) & p-valor          \\ \hline
mu       & (Intercept) & -4009,45   & 249,890 &          & \textless{}0,001 \\
mu       & area        & 5,19       & 0,112   &          & \textless{}0,001 \\
mu       & yearc       & 2,04       & 0,128   &          & \textless{}0,001 \\
mu       & location2   & 49,88      & 5,390   &          & \textless{}0,001 \\
mu       & location3   & 131,62     & 16,555  &          & \textless{}0,001 \\
mu       & cheating1   & 120,11     & 9,041   &          & \textless{}0,001 \\
sigma    & (Intercept) & 4,96       & 0,013   &          & \textless{}0,001
\end{tabular}
\end{table}

---

`r confint(normal_model) %>% kable()`

---

```{r}
plot(
  normal_model, summaries = F, 
  parameters = par(
    mfrow=c(2,2), mar=par("mar")+c(0,1,0,0), 
    col=gray(0.5, 0.5), pch=21, cex=0.8
  ))
```

---


# GAMLSS

## Definição

Sejam $\boldsymbol{\theta} = (\theta_1, ..., \theta_p)'$ os parâmetros da função de densidade (probabilidade) $f(y | \boldsymbol{\theta})$ computável e sua primeira derivada também, e sejam $y_i | \boldsymbol{\theta}, i = 1, ..., n$ respostas independentes.

Sejam $g_k, k = 1, ..., p$ funções de ligação conhecidas que relacionam os parâmetros com as observações. O modelo GAMLSS é:

\[
g_{k}\left(\boldsymbol{\theta}_{k}\right)=\boldsymbol{\eta}_{k}=\mathbf{X}_{k} \boldsymbol{\beta}_{k}+\sum_{j=1}^{J_{k}} \mathbf{Z}_{j k} \boldsymbol{\gamma}_{j k}
\]

- $\boldsymbol{\theta}_k = (\theta^1, ..., \theta^n)'$ e $\boldsymbol{\eta}_k$ (preditores) são vetores de tamanho $n$
- $\mathbf{X}_k$ são matrizes $n \times J_k^\prime$ de planejamento fixas e $\boldsymbol{\beta}_k$ são vetores de parâmetros de tamanho $J_k^\prime$
- $\mathbf{Z}_{j k}$ são matrizes $n \times q_{j k}$ de planejamento fixas e $\boldsymbol{\gamma}_{j k}$ é uma v.a. de dimensão $q_{j k}$
- Observação: $J_k^, J_k\prime$ e $q_{j k}$ são determinados pela quantidade e definição das matrizes de planejamento

---

- Modelos Aditivos para Localização, Escala e Forma (GAMLSS em inglês) foi introduzido por Rigby & Stasinopoulos (2001, 2005) e Akantziliotou \textit{et al.} (2002)
- Mais gerais:
  - A família de funções de densidade (probabilidade) para a resposta é mais geral que a família exponencial
  - É possível modelar todos os parâmetros da distribuição de $\mathbf{Y}$ de forma paramétrica, não paramétrica (suavizadores) ou por efeitos aleatórios

- Geralmente são considerados no máximo quatro parâmetros: $\boldsymbol{\theta} = (\boldsymbol{\mu}, \boldsymbol{\sigma}, \boldsymbol{\nu}, \boldsymbol{\tau})$ sendo o primeiro de localização, o segundo de escala e os restantes de forma (assimetria e curtose, por exemplo).
- O modelo pode ser reduzido para $g_{k}\left(\boldsymbol{\theta}_{k}\right) = \boldsymbol{\eta}_{k} = \mathbf{X}_{k} \boldsymbol{\beta}_{k}$

---

## Diagnóstico

 - Resíduo quantílitico (resposta contínua): $\hat{r}_i = \Phi^{-1}(\hat{u}_i$, onde $\Phi^{-1}$ é a função quantil da normal padrão, $\hat{u}_i = F(y|\hat{\boldsymbol{\theta}})$ são os resíduos quantílicos e $F$ é a fda do modelo proposto para $Y$.

 - Segundo Stasinopoulos \textit{et. al} (2017, pg 419), o resíduo quantílitico normalizado tem sempre distribuição normal padrão quando o modelo para $Y$ é correto.

-  Portanto, as ferramentas de diagnóstico do modelo serão as mesmas do caso normal (gráfico de densidade e QQ-plot), permitindo uma comparação direta entre os modelos.

---


# Modelando por GAMLSS (Modelo Gama)

$$
\mathbf{Y} \stackrel{\mathrm{ind}}{\sim} \text{Gamma}(\boldsymbol{\mu}, \boldsymbol{\sigma}), \quad f(y ; \mu, \sigma^{2})=\frac{y^{1 / \sigma^{2}-1} \exp \left(-\frac{y}{\sigma^{2} \mu}\right)}{(\sigma^{2} \mu)^{(1 / \sigma^{2})} \Gamma(1 / \sigma^{2})}
$$

$$
\begin{aligned} 
  \log(\boldsymbol{\mu}) &= \boldsymbol{\eta}_{1} =  \beta_{10} + \beta_{11} x_{i 1} + \beta_{12} x_{i 2} + \beta_{13} 1(x_{i 3} = 1) + \beta_{14} 1(x_{i 4} = 2) + \beta_{15} 1(x_{i 4} = 3) \\
  \log(\boldsymbol{\sigma}) &= \boldsymbol{\eta}_{2} =  \beta_{20} + \beta_{21} x_{i 1} + \beta_{22} x_{i 2} + \beta_{23} 1(x_{i 3} = 1) + \beta_{24} 1(x_{i 4} = 2) + \beta_{25} 1(x_{i 4} = 3) 
\end{aligned}
$$

---

## Modelo Gama: Resultados

```{r gamma_model}
gamma_model <- gamlss(rent ~ area + yearc + location + cheating,
             sigma.fo = ~ area + yearc + location + cheating,
             family=GA, trace=F, data=df)
```

\begin{table}[]
\centering
\caption{}
\label{tab:gamma_model}
\begin{tabular}{llllll}
\hline
\multicolumn{1}{c}{Parâmero} & Termo       & Estimativa & EP                        & IC(95\%) & p-valor          \\ \hline
mu                           & (Intercept) & -5,164     & \multicolumn{1}{r}{0,527} &          & \textless{}0,001 \\
mu                           & area        & 0,011      & \multicolumn{1}{r}{0,000} &          & \textless{}0,001 \\
mu                           & yearc       & 0,005      & 0,000                     &          & \textless{}0,001 \\
mu                           & location2   & 0,097      & 0,011                     &          & \textless{}0,001 \\
mu                           & location3   & 0,203      & 0,041                     &          & \textless{}0,001 \\
mu                           & cheating1   & 0,281      & 0,024                     &          & \textless{}0,001 \\
sigma                        & (Intercept) & 10,116     & 1,220                     &          & \textless{}0,001 \\
sigma                        & area        & 0,001      & 0,001                     &          & 0,007            \\
sigma                        & yearc       & -0,006     & 0,001                     &          & \textless{}0,001 \\
sigma                        & location2   & 0,081      & 0,026                     &          & 0,002            \\
sigma                        & location3   & 0,244      & 0,080                     &          & 0,002            \\
sigma                        & cheating1   & -0,200     & 0,044                     &          & \textless{}0,001 \\ \hline
\end{tabular}
\end{table}

---

`r confint(gamma_model) %>% kable()`

---

```{r}
plot(
  gamma_model, summaries = F, 
  parameters = par(
    mfrow=c(2,2), mar=par("mar")+c(0,1,0,0), 
    col=rgb(0.5,0.5,0.5, 0.5), pch=21, cex=0.8
  ))
```

---

## Problemas

- Distribuição dos resíduos quantílicos com assimetria negativa no gráfico da densidade estimada
- Comportamento sistemático das caudas no QQ-plot

## Sugestões

- Modelagem de $Y$ com uma distribuição mais apropriada
- Uso de termos não paramétricos

---

# Modelando por GAMLSS (Modelo Box-Cox Normal)

$$
\mathbf{Y} \stackrel{\mathrm{ind}}{\sim} \text{BC}(\boldsymbol{\mu}, \boldsymbol{\sigma}, \boldsymbol{\nu}); \quad


f(y|\mu,\sigma,\nu)=\frac{1}{\sqrt{2\pi\sigma}}\frac{y^{\nu-1}}{mu^\nu}\exp\Big({\frac{-z^2}{2}}\Big) \ \text{onde} \\ \text{se} \ \nu \neq 0 \ \text{então} \ z = \frac{\frac{y}{\mu^{\nu-1}}}{\nu\sigma} \\ \text{caso contrário} \ z = \log\Big(\frac{y}{\mu}\Big)/\sigma \ \text{para} \ y > 0, \mu >0, \sigma >0 \ \text{e} \ \nu =(-\infty,+\infty).
$$
$$
\begin{aligned} 
  \log(\boldsymbol{\mu}) &= \boldsymbol{\eta}_{1} = \beta_{10} + \beta_{11} x_{i 1} + \beta_{12} x_{i 2} + \beta_{13} 1(x_{i 3} = 1) + \beta_{14} 1(x_{i 4} = 2) + \beta_{15} 1(x_{i 4} = 3)  \\ 
  \log(\boldsymbol{\sigma}) &= \boldsymbol{\eta}_{2} = \beta_{20} + \beta_{21} x_{i 1} + \beta_{22} x_{i 2} + \beta_{23} 1(x_{i 3} = 1) + \beta_{24} 1(x_{i 4} = 2) + \beta_{25} 1(x_{i 4} = 3)  \\
  \boldsymbol{\nu} &= \boldsymbol{\eta}_{2} = \beta_{30} + \beta_{31} \mathbf{x}_{2}
\end{aligned}
$$

---

## Modelo Box-Cox Normal: Resultados

```{r}
boxcox_model <- gamlss(rent ~ area + yearc + location + cheating,
             sigma.fo = ~ area + yearc + location + cheating,
             nu.fo = ~ yearc,
             family = BCCGo, trace = F, data = df)
```

\begin{table}[]
\centering
\caption{}
\label{tab:boxcox_model}
\begin{tabular}{llllll}
\hline
Parâmero & Termo       & Estimativa & EP    & IC(95\%) & p-valor          \\ \hline
mu       & (Intercept) & -7,017     & 0,505 &          & \textless{}0,001 \\
mu       & area        & 0,011      & 0,000 &          & \textless{}0,001 \\
mu       & yearc       & 0,006      & 0,000 &          & \textless{}0,001 \\
mu       & location2   & 0,095      & 0,010 &          & \textless{}0,001 \\
mu       & location3   & 0,202      & 0,036 &          & \textless{}0,001 \\
mu       & cheating1   & 0,277      & 0,024 &          & \textless{}0,001 \\
sigma    & (Intercept) & 12,440     & 1,240 &          & \textless{}0,001 \\
sigma    & area        & 0,001      & 0,001 &          & 0,008            \\
sigma    & yearc       & -0,007     & 0,001 &          & \textless{}0,001 \\
sigma    & location2   & 0,079      & 0,027 &          & 0,003            \\
sigma    & location3   & 0,202      & 0,082 &          & 0,014            \\
sigma    & cheating1   & -0,207     & 0,045 &          & \textless{}0,001 \\
nu       & (Intercept) & -17,799    & 3,770 &          & \textless{}0,001 \\
nu       & yearc       & 0,009      & 0,002 &          & \textless{}0,001 \\ \hline
\end{tabular}
\end{table}

---

`r confint(boxcox_model) %>% kable()`

---

```{r}
term.plot(
  gamma_model, what = "mu", data = df, partial.resid = TRUE, 
  col.res = gray(0.5, 0.5), pch.res=21, se = TRUE, pages = 1, ask = FALSE
  )
```

---

```{r}
plot(
  boxcox_model, summaries = F, 
  parameters = par(
    mfrow=c(2,2), mar=par("mar")+c(0,1,0,0), 
    col=gray(0.5, 0.5), pch=21, cex=0.8
  ))
```

---

# Comparação

```{r}
compare_AIC <- AIC(normal_model, gamma_model, boxcox_model)
compare_BIC <- BIC(normal_model, gamma_model, boxcox_model)

R2 <- list(normal = Rsq(normal_model), gamma = Rsq(gamma_model), boxcox = Rsq(boxcox_model))
```

\begin{table}[]
\centering
\caption{}
\label{tab:model_comp}
\begin{tabular}{lllll}
\hline
Modelo & GL & AIC   & BIC   & $R^2$ \\ \hline
X      & 14 & 38463 & 38547 & 0,52  \\
Gama   & 12 & 38527 & 38599 & 0,51  \\
Normal & 7  & 39328 & 39370 & 0,47  \\ \hline
\end{tabular}
\end{table}

## Conclusão


